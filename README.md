# chicken-miner
스토리의 "불가능에 도전합니다...!" 쇼츠 댓글에 있는 치킨 이벤트 쿠폰 매크로

# 무엇을 위한건가요?

[이 영상](https://www.youtube.com/watch?v=YeibvbSAKBs)의 댓글에 존재했던 치킨 이벤트를 위한 매크로입니다.

![](https://user-images.githubusercontent.com/36562850/225617088-13c87cf6-824d-470e-b103-3a868afbbfab.png)

현재는 이벤트가 종료되었습니다. 100만 좋아요 축하드립니다.

# 작동 속도

https://user-images.githubusercontent.com/36562850/225621943-5fae1e77-559e-48e5-8e27-c6f6832d97b0.mp4

# 사용법

## 전제조건
- **Chrome 1번 탭에** BHC 주문 탭이 **"포장주문"으로** 열려있어야 합니다. 포장으로 해야 후반에 주문 버튼을 바로 누를 수 있습니다.
  - BHC 주문 탭 설정 완료 기준은 E-쿠폰 사용이 이미 눌려 있고 숫자 CAPTCHA 코드 인증이 완료되어 있어야 합니다.
- AutoHotKey가 설치되어 있어야하며 F9키가 다른 단축키로 할당되어 있지 않아야 합니다.
- OCR을 돌릴 만한 컴퓨터 사양이 되어야합니다. 아마 적당한 컴퓨터들에서 대부분 다 돌아갈것으로 예상됩니다.
- AutoHotKey 마우스 좌표 기준은 2560x1440에 화면 전체를 기준으로 한 좌표입니다.

## 설정

[Main.kt](./src/main/kotlin/io/github/lambdynma/chickenminer/Main.kt)에서 `GOOGLE_DRIVE_FOLDER_LINK`가 파일 변화 확인을 원하는 구글 드라이브 폴더의 링크로 설정되어 있어야 하며, 해당 구글 드라이브는 "링크가 있으면 모두 볼 수 있음"의 권한으로 설정되어 있어야합니다.

Google OAuth가 설정되지 않은 경우:
1. https://console.cloud.google.com/ 에서 Google Drive API를 활성화 하고 OAuth 클라이언트 Credential을 얻습니다.
2. 실행하는 디렉터리에 `credentials.json`의 이름으로 저장합니다.
3. 최초 실행하고 원하는 구글 계정으로 로그인합니다.

Google OAuth 설정 이후:
1. AutoHotKey 매크로를 실행하고 BHC 탭을 준비합니다.
2. 대기합니다.
3. 새 파일이 자동으로 감지되면 [changeFocus.vbs](./changeFocus.vbs)가 실행되고 F9키가 눌립니다.
4. 정상적으로 설정되었을 경우 자동으로 마우스와 키보드 입력을 조작하여 주문이 완료됩니다.

# 원리

1. 전제 조건을 준비합니다.
2. 실행 시 Google OAuth가 정상 설정되어 있는 경우, 파일 변화를 감시하는 구글 드라이브 파일을 200ms마다 변화를 감시합니다.
3. 변화 확인시 작동 시작 시점에 변수에 기록한 파일 목록과 비교하여 새 파일 내용을 따로 구합니다.
4. (사진 해상도 변화가 없고 쿠폰 코드의 위치 변화가 없을 경우) Tesseract를 이용해 OCR을 실행하며 최종 쿠폰코드를 클립보드에 자동 복사합니다.
   - 따로 학습된 파일이 있어야합니다. [eng.traineddata](./eng.traineddata)를 이용하시면 됩니다.
5. [changeFocus.vbs](./changeFocus.vbs)를 이용해 활성 화면을 Chrome으로 변경 한 뒤 F9 키를 입력해 AutoHotKey 매크로를 실행합니다.

# 한계

- 2560x1440 해상도 고정의 한계
- 쿠폰 코드 위치 변경에 대처 불가능 한계
- 쿠폰 코드가 BHC가 아닐 경우에 대처 불가능 한계
- 여러개의 쿠폰 코드가 한번에 추가될 경우 이를 모두 처리 할 수 없는 한계
- 감시 간격이 200ms보다 더 빠르거나, 느릴 때 작동이 불가능한 한계 (+ 200ms로 설정시 아주 가끔씩 TimeoutException 발생)
- 완전 자동이 아님. 사람의 관리가 필요함.

# 여담

1. 여러 서비스 약관의 위배되지 않도록, Quota limit에 걸리지 않도록 테스트 하였습니다.

2. 스토리님 본인께서 스토리게임 디스코드에 **직접** 공정해야 할 필요가 없다고 말씀하셨습니다.

![](https://user-images.githubusercontent.com/36562850/225615837-2e4ac737-2439-4344-93c8-f71b19f9d760.png)

돈만 노리고 한게 아니라고 이야기하면 거짓말이겠지만, 저 혼자서 쿠폰을 다 먹진 않았고 지인들도 돌려서 줬습니다. 총 5개 정도를 성공했고 수십개는 여러 테스트를 거쳤음에도 버그로 실패 한 것 같네요.

3. 앞으로 매크로를 돌리면서 참여할 일은 없습니다. 만들지 않고, 만들 일도 없습니다. 관련되어서 제게 요청하지 마세요.

현재 작성한 코드도 언제 어디서 버그가 생길지 모릅니다. 고칠 생각은 없습니다.

4. 사실 AutoHotKey 버그 있을때마다 직접 숫자코드 입력하는 경우가 종종 있어서 BHC 클라이언트 자바스크립트 소스코드를 뜯어서 최종 주문 URL로 POST 요청을 보내는 생각도 했는데, 사이트 전반적 구조를 다 뜯어야 하는데다가 시간낭비일거 같아 그냥 포기했습니다.
  - 자바스크립트 소스코드 일부를 뜯고 디버그 브레이크포인트를 찍는 과정에서 아래와 같은 함수를 발견했습니다. 쿠폰 주문이 아닌 일반 주문시에 전화번호 인증번호 생성 요청을 위해 불리는 것 같은데 실제 값을 확인 가능한지는 테스트해보지 못했습니다만 이렇게 클라이언트측에 인증코드를 두면 과연 인증에 큰 효과가 있을지 의문입니다. 혹 BHC 웹 개발자분께서 이 레포를 보시게 된다면 참고 부탁드립니다.
  ![](https://user-images.githubusercontent.com/36562850/225640345-c219d3fd-9d31-41a7-a86c-758733347220.png)

5. 스토리님이 직접, 혹은 BHC 관계자분들께서 이 레포지토리가 내려가길 원하시는 경우 연락해주세요. 최대한 빠른 시간 내로 내리겠습니다.
  - 업로드 목적은 단순히 매크로가 아닌 **구글 드라이브 API 활용**과 **Tesseract를 이용한 OCR 시도**에 관심이 있을 분들을 위해 업로드 한 목적이 포함되어 있음을 알려드립니다.